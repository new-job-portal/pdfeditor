<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Passport Photo Maker — Auto Enhance & 30-on-A4</title>
<style>

  :root{
  --bg:#7086f5;
  --card:#161a2b;
  --muted:#8ba4ff;
  --accent:#4862ff;
  --card-border:#232744;
  --tool-bg:#111522;

}

*{box-sizing:border-box}
body{
    margin:0;
    font-family:Inter,Arial,Helvetica,sans-serif;
    background:var(--bg);
    color:white;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
}
  body { font-family: system-ui, -apple-system, Roboto, "Noto Sans", sans-serif; margin: 12px; color:#111; }
  h1 { font-size: 20px; margin: 0 0 12px 0; }
  .controls { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; align-items:center;}
  .box { border:1px solid #ddd; padding:10px; border-radius:8px; background:#fafafa; }
  label { font-size:13px; display:block; margin-bottom:6px; }
  input[type="file"] { display:block; }
  #gallery { display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
  .thumb { width:160px; border:1px solid #eee; padding:8px; border-radius:6px; background:white; box-shadow:0 1px 2px rgba(0,0,0,0.03);}
  .thumb img { display:block; width:100%; height:max-content; object-fit:cover; border-radius:4px; }
  .thumb .meta { margin-top:6px; font-size:12px; }
  button { padding:6px 10px; border-radius:10px; border:2px solid #ff0101; cursor:pointer; background:#1337ec; color:white;}
  button:disabled { opacity:0.5; cursor:not-allowed; }
  .small { font-size:12px; padding:4px 8px; }
  #sheetCanvas { width:100%; max-width:900px; border:1px dashed #bbb; margin-top:12px; background:#fff; }
  .note { font-size:13px; color:#444; margin-top:8px; }
  .row { display:flex; gap:8px; align-items:center; }
  input[type="number"] { width:80px; padding:6px; border-radius:6px; border:1px solid #ccc; }
  select { padding:6px; border-radius:6px; border:1px solid #ccc;}
  #shopName {
    width: auto !important;
    min-width: 50px;
    font-size: 13px;
    padding: 2px 4px;
}

.tool-box {
    background:#1337ec;
    padding:12px;
    margin-bottom:12px;
  
    color:#fff;
    font-size:14px;
    border-radius:20px; 
    border:1px solid #ff0101;
}

.tool-box h3 {
    margin-bottom:6px;
    font-size:16px;
}

.tool-box input[type=range] {
    width:100%;
    margin:6px 0 18px 0;
}
h1{
  color: #fff;
}


/* Modal editor */
.editor-modal{ position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:9999; }
.editor-card{ width:880px; max-width:95%; height: 880px;max-height: 85%;    background:#fff; color:#111; border-radius:10px; padding:5px; box-shadow:0 8px 30px rgba(0,0,0,0.4); }
.editor-row{ display:flex; gap:12px; }
.editor-canvas{ flex:1; border:1px solid #ddd; border-radius:6px; background:#f6f6f6; display:flex; align-items:center; justify-content:center; }
.slider { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
.slider label{ width:120px; font-size:13px; }
.slider input[type=range]{ flex:1; }
.editor-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:20px; }

</style>

</head>
<body>
  <h1>Passport Photo Maker — AI Auto-Enhance </h1>

  <div class="controls">
    <div class="tool-box">
      <label>1) Images </label>
      <input id="fileInput" type="file" accept="image/*" multiple />
      <div class="note"></div>
    
    </div>

    <div class="tool-box">
      <label>2) Passport size (आप mm में बदल सकते हैं)</label>
      <div class="row">
        <div>
          <label>चौड़ाई (mm)</label>
          <input id="pw" type="number" value="35" min="10" />
        </div>
        <div>
          <label>ऊँचाई (mm)</label>
          <input id="ph" type="number" value="45" min="10" />
        </div>
        <div>
          <label>DPI (print quality)</label>
          <input id="dpi" type="number" value="1200" min="96" />
        </div>
      </div>
      
    </div>

    <div class="tool-box">
      <label>3) Layout </label>
      <div class="row">
        <div>
          <label>Columns</label>
          <select id="cols"><option>5</option><option>4</option><option>3</option><option>2</option><option>1</option></select>
        </div>
        <div>
          <label>Rows</label>
          <select id="rows"><option>5</option><option>6</option><option>4</option><option>3</option><option>2</option><option>1</option></select>
        </div>
      </div>

    </div>



    <!-- Add inside the .controls div (ek naya box) -->
<div class="tool-box">
  <label>4) Photo Border Settings</label>
  <div class="row">
    <div>
      <label>Border Color</label>
      <input id="borderColor" type="color" value="#000000" />
    </div>
    <div>
      <label>Border Thickness (px)</label>
      <input id="borderWidth" type="number" value="2" min="0" />
    </div>
  </div>

</div>


<!-- ⭐ NEW BOX: Shop Name Print Box (NO CHANGE TO EXISTING CODE) -->
<div class="tool-box">
  <label>5) Shop Name (Photo ke Left Side Vertically Print Hoga)</label>
  <input id="shopName" type="text" placeholder="Shop Name likhiye" style="width:160px; padding:6px; border-radius:6px; border:1px solid #ccc;">
 
</div>
<!-- ⭐ NEW BOX END -->







<script>
const shopInput = document.getElementById("shopName");

function autoResizeShop() {
    const temp = document.createElement("span");
    temp.style.visibility = "hidden";
    temp.style.whiteSpace = "pre";
    temp.style.fontSize = window.getComputedStyle(shopInput).fontSize;
    temp.innerText = shopInput.value || " ";
    document.body.appendChild(temp);

    shopInput.style.width = (temp.offsetWidth + 10) + "px";

    temp.remove();
}

shopInput.addEventListener("input", autoResizeShop);
autoResizeShop();
</script>




    
  </div>

  <div>
    <button id="generateBtn" class="small">Photo Preview</button>
    <button id="downloadBtn" class="small" disabled>Download PNG File</button>
    <button id="clearBtn" class="small">Clear All Photo</button>
    <button id="printBtn" class="small" disabled>Print Photo</button>

  </div>

  <div id="gallery"></div>

  <canvas id="sheetCanvas" width="2480" height="3508" style="display:block"></canvas>

  <div id="editorModal" class="editor-modal" style="display:none">
  <div class="editor-card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <strong>Image Editor — Live Adjust</strong>
      <button id="closeEditor">Close</button>
    </div>
    <div class="editor-row">
      <div class="editor-canvas">
        <canvas id="editCanvas" width="600" height="600" style="max-width:100%; height:auto; border-radius:6px;"></canvas>
      </div>
      <div style="width:320px;">
        <div class="slider"><label>Brightness</label><input id="s_brightness" type="range" min="50" max="150" value="100"></div>
        <div class="slider"><label>Contrast</label><input id="s_contrast" type="range" min="50" max="150" value="100"></div>
        <div class="slider"><label>Saturation</label><input id="s_saturation" type="range" min="0" max="200" value="100"></div>
        <div class="slider"><label>Hue (deg)</label><input id="s_hue" type="range" min="-180" max="180" value="0"></div>
        <div class="slider"><label>Blur (px)</label><input id="s_blur" type="range" min="0" max="8" value="0"></div>
        <div class="slider"><label>Sharpness</label><input id="s_sharp" type="range" min="0" max="200" value="0"></div>
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="saveEdit" class="small">Save</button>
          <button id="resetEdit" class="small">Reset</button>
        </div>
      </div>
    </div>
  </div>
</div>

  <script>
  // Utility: mm to pixels at DPI
  function mmToPx(mm, dpi) {
    return Math.round((mm / 25.4) * dpi);
  }

  // Image store
  const images = []; // {file, imgElement, enhanced:bool, editedDataURL}

  const fileInput = document.getElementById('fileInput');
  const gallery = document.getElementById('gallery');
  const generateBtn = document.getElementById('generateBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  const clearBtn = document.getElementById('clearBtn');
  const printBtn = document.getElementById('printBtn');

  const sheetCanvas = document.getElementById('sheetCanvas');
  const ctxSheet = sheetCanvas.getContext('2d');

  fileInput.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files).slice(0, 30 - images.length);
    for (const file of files) {
      if (!file.type.startsWith('image/')) continue;
      const dataURL = await readFileAsDataURL(file);
      const img = await createImage(dataURL);
      const item = { file, img, enhanced:false, dataURL };
      images.push(item);
      renderGallery();
    }
    fileInput.value = '';
  });

  clearBtn.addEventListener('click', () => {
    images.length = 0;
    renderGallery();
    downloadBtn.disabled = true;
    ctxSheet.clearRect(0,0,sheetCanvas.width,sheetCanvas.height);
  });

  function renderGallery(){
    gallery.innerHTML = '';
    images.forEach((it, idx) => {
      const div = document.createElement('div');
      div.className = 'thumb';
      div.innerHTML = `
        <img src="${it.enhanced ? it.dataURL : it.img.src}" />
        <div class="meta">
          <div>File: ${escapeHtml(it.file.name)}</div>
          <div style="margin-top:6px;">
            <button data-idx="${idx}" class="enhBtn small">${it.enhanced ? 'Enhanced ✅' : 'Auto Enhance'}</button>
            <button data-idx="${idx}" class="editBtn small">Edit</button>
            <button data-idx="${idx}" class="removeBtn small">Remove</button>
          </div>
        </div>
      `;
      gallery.appendChild(div);
    });

    // attach handlers
    gallery.querySelectorAll('.enhBtn').forEach(b=>{
      b.addEventListener('click', async (ev)=>{
        const i = +b.getAttribute('data-idx');
        if (images[i].enhanced) return;
        b.disabled = true;
        b.textContent = 'Applying...';
        try {
          await autoEnhanceImage(images[i]);
          images[i].enhanced = true;
          b.textContent = 'Enhanced ✅';
          b.disabled = true;
          renderGallery();
        } catch(err) {
          console.error(err);
          b.disabled = false;
          b.textContent = 'Auto Enhance';
          alert('Enhance fail: ' + err);
        }
      });
    });

      gallery.querySelectorAll('.editBtn').forEach(b=>{
    b.addEventListener('click',(ev)=>{
      const i = +b.getAttribute('data-idx');
      openEditor(i);
    });
  });

    gallery.querySelectorAll('.removeBtn').forEach(b=>{
      b.addEventListener('click', (ev)=>{
        const i = +b.getAttribute('data-idx');
        images.splice(i,1);
        renderGallery();
      });
    });
  }


  
// ---------------- Editor logic ----------------
const editorModal = document.getElementById('editorModal');
const editCanvas = document.getElementById('editCanvas');
const eCtx = editCanvas.getContext('2d');
let editingIndex = -1;

const s_brightness = document.getElementById('s_brightness');
const s_contrast = document.getElementById('s_contrast');
const s_saturation = document.getElementById('s_saturation');
const s_hue = document.getElementById('s_hue');
const s_blur = document.getElementById('s_blur');
const s_sharp = document.getElementById('s_sharp');
const saveEdit = document.getElementById('saveEdit');
const resetEdit = document.getElementById('resetEdit');
const closeEditor = document.getElementById('closeEditor');

function openEditor(idx){
  editingIndex = idx;
  const item = images[idx];
  // set default sliders
  s_brightness.value = 100;
  s_contrast.value = 100;
  s_saturation.value = 100;
  s_hue.value = 0;
  s_blur.value = 0;
  s_sharp.value = 0;

  // load image into canvas sized appropriately
  const img = new Image();
  img.onload = ()=>{
    // resize canvas to fit image but limit to 1000px
    const max = 900;
    let w = img.naturalWidth, h = img.naturalHeight;
    const scale = Math.min(max / Math.max(w,h), 1);
    editCanvas.width = Math.round(w * scale);
    editCanvas.height = Math.round(h * scale);
    applyFiltersLive();
    editorModal.style.display = 'flex';
  };
  img.src = item.enhanced ? item.dataURL : item.img.src;
}

function getCurrentFilters(){
  return {
    brightness: Number(s_brightness.value),
    contrast: Number(s_contrast.value),
    saturation: Number(s_saturation.value),
    hue: Number(s_hue.value),
    blur: Number(s_blur.value),
    sharp: Number(s_sharp.value)
  };
}

async function applyFiltersLive(){
  if (editingIndex < 0) return;
  const item = images[editingIndex];
  const img = await createImage(item.enhanced ? item.dataURL : item.img.src);
  const w = editCanvas.width, h = editCanvas.height;
  // build ctx.filter string
  const f = getCurrentFilters();
  const filterStr = `brightness(${f.brightness}%) contrast(${f.contrast}%) saturate(${f.saturation}%) hue-rotate(${f.hue}deg) blur(${f.blur}px)`;
  eCtx.clearRect(0,0,w,h);
  eCtx.save();
  eCtx.filter = filterStr;
  // draw cover fit
  const srcW = img.naturalWidth, srcH = img.naturalHeight;
  const dstRatio = w/h; const srcRatio = srcW/srcH;
  let sx, sy, sw, sh;
  if (srcRatio > dstRatio){
    sh = srcH; sw = Math.round(sh * dstRatio); sx = Math.round((srcW - sw)/2); sy = 0;
  } else {
    sw = srcW; sh = Math.round(sw / dstRatio); sx = 0; sy = Math.round((srcH - sh)/2);
  }
  eCtx.drawImage(img, sx, sy, sw, sh, 0,0, w, h);
  eCtx.restore();

  // apply sharpen if requested
  if (f.sharp > 0){
    const imgData = eCtx.getImageData(0,0,w,h);
    const sharpAmount = f.sharp / 100; // 0..2
    const result = unsharpMaskData(imgData, sharpAmount, 1);
    eCtx.putImageData(result, 0,0);
  }
}

// listen sliders
[s_brightness, s_contrast, s_saturation, s_hue, s_blur, s_sharp].forEach(el=>{
  el.addEventListener('input', ()=>{
    applyFiltersLive();
  });
});

closeEditor.addEventListener('click', ()=>{ editorModal.style.display='none'; editingIndex = -1; });

resetEdit.addEventListener('click', ()=>{
  s_brightness.value = 100; s_contrast.value = 100; s_saturation.value = 100; s_hue.value = 0; s_blur.value = 0; s_sharp.value = 0; applyFiltersLive();
});

saveEdit.addEventListener('click', ()=>{
  if (editingIndex < 0) return;
  const dataURL = editCanvas.toDataURL('image/jpeg', 0.92);
  images[editingIndex].dataURL = dataURL;
  images[editingIndex].enhanced = true;
  renderGallery();
  editorModal.style.display='none';
  editingIndex = -1;
});

// ---------------- image helpers ----------------
function readFileAsDataURL(file){
  return new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = ()=> res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}
function createImage(dataURL){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=> res(img);
    img.onerror = rej;
    img.src = dataURL;
  });
}

function escapeHtml(s){ return s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }


  // Auto-enhance: apply simple auto white balance (Gray World) + histogram stretch per channel
  async function autoEnhanceImage(item) {
    // draw to offscreen canvas
    const img = item.img;
    const w = img.naturalWidth;
    const h = img.naturalHeight;
    const off = document.createElement('canvas');
    off.width = w; off.height = h;
    const g = off.getContext('2d');
    g.drawImage(img,0,0,w,h);
    let imgData = g.getImageData(0,0,w,h);
    const data = imgData.data;

    // Auto white balance: Gray World
    let rSum=0,gSum=0,bSum=0, cnt=0;
    for (let i=0;i<data.length;i+=4){
      rSum += data[i];
      gSum += data[i+1];
      bSum += data[i+2];
      cnt++;
    }
    rSum/=cnt; gSum/=cnt; bSum/=cnt;
    const gray = (rSum + gSum + bSum)/3;
    const rGain = gray / (rSum||1);
    const gGain = gray / (gSum||1);
    const bGain = gray / (bSum||1);
    for (let i=0;i<data.length;i+=4){
      data[i] = clamp(data[i]*rGain);
      data[i+1] = clamp(data[i+1]*gGain);
      data[i+2] = clamp(data[i+2]*bGain);
    }

    // Histogram stretch per channel
    const hist = { r:new Uint32Array(256), g:new Uint32Array(256), b:new Uint32Array(256) };
    for (let i=0;i<data.length;i+=4){
      hist.r[data[i]]++;
      hist.g[data[i+1]]++;
      hist.b[data[i+2]]++;
    }
    // find low/high percentile (1% and 99%)
    function getStretchLUT(harr){
      const total = harr.reduce((a,b)=>a+b,0);
      const lowCount = Math.max(1, Math.floor(total*0.01));
      const highCount = Math.max(1, Math.floor(total*0.99));
      let cum=0, lowV=0, highV=255;
      for (let i=0;i<256;i++){
        cum += harr[i];
        if (cum >= lowCount){ lowV = i; break; }
      }
      cum = 0;
      for (let i=255;i>=0;i--){
        cum += harr[i];
        if (cum >= (total - highCount)){ highV = i; break; }
      }
      // build LUT
      const lut = new Uint8Array(256);
      const denom = (highV - lowV) || 1;
      for (let i=0;i<256;i++){
        let v = Math.round((i - lowV) * 255 / denom);
        lut[i] = clamp(v);
      }
      return lut;
    }
    const rLUT = getStretchLUT(hist.r);
    const gLUT = getStretchLUT(hist.g);
    const bLUT = getStretchLUT(hist.b);
    for (let i=0;i<data.length;i+=4){
      data[i] = rLUT[data[i]];
      data[i+1] = gLUT[data[i+1]];
      data[i+2] = bLUT[data[i+2]];
    }

    // small unsharp mask (light sharpening)
    const sharpened = unsharpMask(imgData, 0.6, 1);
    g.putImageData(sharpened,0,0);

    // set new dataURL
    item.dataURL = off.toDataURL('image/jpeg', 0.92);
  }

  // clamp util
  function clamp(v){ return v < 0 ? 0 : (v > 255 ? 255 : Math.round(v)); }

  // Read file -> DataURL
  function readFileAsDataURL(file){
    return new Promise((res, rej) => {
      const fr = new FileReader();
      fr.onload = ()=> res(fr.result);
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
  }

  // create Image from dataURL
  function createImage(dataURL){
    return new Promise((res, rej)=>{
      const img = new Image();
      img.onload = ()=> res(img);
      img.onerror = rej;
      img.src = dataURL;
    });
  }

  // Unsharp mask - lightweight: blur using box blur then combine
  function unsharpMask(imageData, amount=0.5, radius=1){
    // Very simple box blur for small radius (1)
    const w = imageData.width, h = imageData.height;
    const src = imageData.data;
    const dst = new Uint8ClampedArray(src.length);
    // blur -> tmp
    const tmp = new Uint32Array(src.length);
    // box blur kernel 3x3
    for (let y=0;y<h;y++){
      for (let x=0;x<w;x++){
        let r=0,g=0,b=0,a=0, cnt=0;
        for (let ky=-radius; ky<=radius; ky++){
          const yy = y+ky;
          if (yy<0||yy>=h) continue;
          for (let kx=-radius; kx<=radius; kx++){
            const xx = x+kx;
            if (xx<0||xx>=w) continue;
            const idx = (yy*w + xx)*4;
            r += src[idx]; g += src[idx+1]; b += src[idx+2]; a += src[idx+3];
            cnt++;
          }
        }
        const i = (y*w + x)*4;
        tmp[i] = r/cnt; tmp[i+1] = g/cnt; tmp[i+2] = b/cnt; tmp[i+3] = a/cnt;
      }
    }
    // combine: dst = src + amount*(src - blur)
    for (let i=0;i<src.length;i+=4){
      dst[i]   = clamp(src[i]   + amount * (src[i]   - tmp[i]));
      dst[i+1] = clamp(src[i+1] + amount * (src[i+1] - tmp[i+1]));
      dst[i+2] = clamp(src[i+2] + amount * (src[i+2] - tmp[i+2]));
      dst[i+3] = src[i+3];
    }
    return new ImageData(dst, w, h);
  }

  // Basic HTML-escape for filenames
  function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // Generate A4 sheet
  generateBtn.addEventListener('click', async ()=>{
    if (images.length === 0){ alert('Koi image upload nahi hai.'); return; }
    const dpi = parseInt(document.getElementById('dpi').value) || 1200;
    const cols = parseInt(document.getElementById('cols').value) || 6;
    const rows = parseInt(document.getElementById('rows').value) || 5;
    const pw_mm = parseFloat(document.getElementById('pw').value) || 35;
    const ph_mm = parseFloat(document.getElementById('ph').value) || 45;

    // A4 dimensions in px at DPI
    const A4_w_px = mmToPx(210, dpi);
    const A4_h_px = mmToPx(297, dpi);
    sheetCanvas.width = A4_w_px;
    sheetCanvas.height = A4_h_px;
    // scale canvas visual size to fit but keep internal px for download
    sheetCanvas.style.width = Math.min(900, A4_w_px/ (dpi/72)) + 'px';

    // clear
    ctxSheet.fillStyle = '#ffffff';
    ctxSheet.fillRect(0,0, sheetCanvas.width, sheetCanvas.height);

    // slot size px
    const photo_w = mmToPx(pw_mm, dpi);
    const photo_h = mmToPx(ph_mm, dpi);
    // compute margins so grid centers
    
  
    // compute margins so grid centers (default)
let hGap = Math.max(10, Math.floor((sheetCanvas.width - (cols*photo_w)) / (cols+1)));
let vGap = Math.max(10, Math.floor((sheetCanvas.height - (rows*photo_h)) / (rows+1)));

let startX = hGap;
let startY = vGap;

// ⭐ FIX: Agar sirf 1 row ho, to TOP se start kare — center nahi
if (rows === 1) {
    startY = 10;     // Very top margin
    vGap = 10;       // कोई vertical gap नहीं चाहिए
}


    // for each cell, draw image (use enhanced if available, else original)
    let idx = 0;
    for (let r=0; r<rows; r++){
      for (let c=0; c<cols; c++){
        const x = startX + c * (photo_w + hGap);
        const y = startY + r * (photo_h + vGap);
        const imgObj = images[idx % images.length]; // repeat if fewer than 30
        const srcImg = imgObj.enhanced ? await createImage(imgObj.dataURL) : imgObj.img;

        // center-crop to fit photo_w x photo_h while preserving aspect ratio
        drawCover(ctxSheet, srcImg, x, y, photo_w, photo_h);


        // ⭐ Shop Name Vertical Print
const shop = document.getElementById('shopName').value.trim();
if (shop !== "") {
    ctxSheet.save();
    ctxSheet.translate(x - 20, y + photo_h / 2);
    ctxSheet.rotate(-Math.PI / 2);
    ctxSheet.fillStyle = "#000";
    ctxSheet.font = Math.floor(photo_h * 0.07) + "px sans-serif";
    ctxSheet.textAlign = "center";
    ctxSheet.fillText(shop, 0, 0);
    ctxSheet.restore();
}


          // <-- Yahan add karein -->
      const borderColor = document.getElementById('borderColor').value;
      const borderWidth = parseInt(document.getElementById('borderWidth').value) || 0;
      if (borderWidth > 0) {
        ctxSheet.strokeStyle = borderColor;
        ctxSheet.lineWidth = borderWidth;
        ctxSheet.strokeRect(x, y, photo_w, photo_h);
      }
      // <-- Yahan tak -->


        idx++;
        if (idx >= cols*rows) break;
      }
      if (idx >= cols*rows) break;
    }

    // optional: draw faint cut-lines
    ctxSheet.strokeStyle = 'rgba(0,0,0,0.08)';
    ctxSheet.lineWidth = Math.max(1, Math.round(dpi/150));
    idx = 0;
    for (let r=0; r<rows; r++){
      for (let c=0; c<cols; c++){
   const namePadding = 20;   // ⭐ yahan aap padding badha sakte ho (px)
const x = startX + namePadding + c * (photo_w + hGap);
const y = startY + r * (photo_h + vGap);

        ctxSheet.strokeRect(x+2, y+2, photo_w-4, photo_h-4);
        idx++; if (idx>=cols*rows) break;
      }
      if (idx>=cols*rows) break;
    }

    downloadBtn.disabled = false;
    printBtn.disabled = false;

    alert('Preview ready — agar theek lage to "Download" par click karo.');
  });

  // Draw image cover (center crop) in target rectangle
  function drawCover(ctx, img, dx, dy, dw, dh){
    const sw = img.naturalWidth || img.width;
    const sh = img.naturalHeight || img.height;
    const dstRatio = dw/dh;
    const srcRatio = sw/sh;
    let sx, sy, swc, shc;
    if (srcRatio > dstRatio){
      // source wider -> crop sides
      shc = sh;
      swc = Math.round(shc * dstRatio);
      sx = Math.round((sw - swc)/2);
      sy = 0;
    } else {
      // source taller -> crop top/bottom
      swc = sw;
      shc = Math.round(swc / dstRatio);
      sx = 0;
      sy = Math.round((sh - shc)/2);
    }
    ctx.drawImage(img, sx, sy, swc, shc, dx, dy, dw, dh);
  }

  // Download generated sheet as PNG
  downloadBtn.addEventListener('click', ()=>{
    const a = document.createElement('a');
    a.href = sheetCanvas.toDataURL('image/png');
    a.download = 'passport_sheet.png';
    a.click();
  });

  printBtn.addEventListener('click', ()=>{
  const dataUrl = sheetCanvas.toDataURL('image/png');
  const w = window.open('');
  w.document.write('<img src="'+dataUrl+'" style="width:100%; display:block; margin:0 auto;">');
  w.document.close();
  w.focus();
  w.print();
});


  // Simple helper: attempt to keep operations non-blocking for many images
  // (Not required here.)

  </script>
</body>
</html>

